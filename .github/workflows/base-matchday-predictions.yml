name: Base Matchday Predictions

# Reusable workflow for matchday predictions
on:
  workflow_call:
    inputs:
      community:
        description: 'Kicktipp community name'
        required: true
        type: string
      model:
        description: 'OpenAI model to use for predictions'
        required: true
        type: string
      community_context:
        description: 'Community context when generating predictions (or using stored ones from the database)'
        required: true
        type: string
      trigger_type:
        description: 'How this workflow was triggered (scheduled, manual)'
        required: true
        type: string
      force_prediction:
        description: 'Force prediction even if verify passes'
        required: false
        type: boolean
        default: false
      max_repredictions:
        description: 'Maximum number of repredictions allowed (0-based index)'
        required: false
        type: number
        default: 2
    secrets:
      kicktipp_username:
        description: 'Kicktipp username for this community'
        required: true
      kicktipp_password:
        description: 'Kicktipp password for this community'
        required: true
      firebase_project_id:
        description: 'Firebase project ID'
        required: true
      firebase_service_account_json:
        description: 'Firebase service account JSON'
        required: true
      openai_api_key:
        description: 'OpenAI API key'
        required: true

env:
  TZ: 'Europe/Berlin'

jobs:
  matchday-predictions:
    name: Matchday Predictions
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.x'
          
      - name: Restore dependencies
        run: dotnet restore
        
      - name: Build project
        run: dotnet build --no-restore --configuration Release
        
      - name: Verify current predictions
        id: verify
        continue-on-error: true
        run: |
          echo "🔍 Verifying current matchday predictions..."
          echo "Community: ${{ inputs.community }}"
          echo "Model: ${{ inputs.model }}"
          echo "Community Context: ${{ inputs.community_context }}"
          dotnet run --project src/Orchestrator --configuration Release -- verify "${{ inputs.model }}" --community "${{ inputs.community }}" --community-context "${{ inputs.community_context }}" --init-matchday --check-outdated --agent --verbose
        env:
          KICKTIPP_USERNAME: ${{ secrets.kicktipp_username }}
          KICKTIPP_PASSWORD: ${{ secrets.kicktipp_password }}
          FIREBASE_PROJECT_ID: ${{ secrets.firebase_project_id }}
          FIREBASE_SERVICE_ACCOUNT_JSON: ${{ secrets.firebase_service_account_json }}
          OPENAI_API_KEY: ${{ secrets.openai_api_key }}
          
      - name: Generate and post predictions
        id: generate
        if: steps.verify.outcome == 'failure' || inputs.force_prediction == true
        run: |
          echo "🤖 Generating predictions with model: ${{ inputs.model }}"
          echo "Community: ${{ inputs.community }}"
          echo "Community Context: ${{ inputs.community_context }}"
          echo "Max Repredictions: ${{ inputs.max_repredictions }}"
          if [ "${{ steps.verify.outcome }}" = "failure" ]; then
            echo "📝 Predictions needed - verify command indicated missing or mismatched predictions"
          else
            echo "🔄 Force prediction enabled - running regardless of verify result"
          fi
          
          # Use reprediction logic with max repredictions limit unless force prediction is enabled
          if [ "${{ inputs.force_prediction }}" = "true" ]; then
            PREDICTION_FLAGS="--override-database"
            echo "💾 Using --override-database flag to force regeneration of predictions"
          else
            PREDICTION_FLAGS="--max-repredictions ${{ inputs.max_repredictions }}"
            echo "🔄 Using reprediction logic with max repredictions: ${{ inputs.max_repredictions }}"
          fi
          
          dotnet run --project src/Orchestrator --configuration Release -- matchday "${{ inputs.model }}" --community "${{ inputs.community }}" --community-context "${{ inputs.community_context }}" --override-kicktipp --verbose --agent $PREDICTION_FLAGS
        env:
          KICKTIPP_USERNAME: ${{ secrets.kicktipp_username }}
          KICKTIPP_PASSWORD: ${{ secrets.kicktipp_password }}
          FIREBASE_PROJECT_ID: ${{ secrets.firebase_project_id }}
          FIREBASE_SERVICE_ACCOUNT_JSON: ${{ secrets.firebase_service_account_json }}
          OPENAI_API_KEY: ${{ secrets.openai_api_key }}
          
      - name: Final verification
        if: steps.verify.outcome == 'failure' || inputs.force_prediction == true
        run: |
          echo "✅ Running final verification to confirm predictions were posted successfully..."
          dotnet run --project src/Orchestrator --configuration Release -- verify "${{ inputs.model }}" --community "${{ inputs.community }}" --community-context "${{ inputs.community_context }}" --agent --verbose
        env:
          KICKTIPP_USERNAME: ${{ secrets.kicktipp_username }}
          KICKTIPP_PASSWORD: ${{ secrets.kicktipp_password }}
          FIREBASE_PROJECT_ID: ${{ secrets.firebase_project_id }}
          FIREBASE_SERVICE_ACCOUNT_JSON: ${{ secrets.firebase_service_account_json }}
          OPENAI_API_KEY: ${{ secrets.openai_api_key }}
          
      - name: Success notification
        if: steps.verify.outcome == 'success' && inputs.force_prediction == false
        run: |
          echo "✅ All predictions are up to date - no action needed"
          
      - name: Workflow summary
        if: always()
        run: |
          echo "## Matchday Predictions Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Community**: ${{ inputs.community }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Model**: ${{ inputs.model }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Community Context**: ${{ inputs.community_context }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Max Repredictions**: ${{ inputs.max_repredictions }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: ${{ inputs.trigger_type }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Verify Result**: ${{ steps.verify.outcome }}" >> $GITHUB_STEP_SUMMARY
          
          # Determine action based on what actually happened
          if [ "${{ steps.verify.outcome }}" = "success" ] && [ "${{ inputs.force_prediction }}" != "true" ]; then
            echo "- **Action**: No predictions needed" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.generate.outcome }}" = "success" ]; then
            echo "- **Action**: Predictions generated and posted successfully" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.generate.outcome }}" = "failure" ]; then
            echo "- **Action**: Prediction generation failed" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.generate.outcome }}" = "skipped" ]; then
            echo "- **Action**: Prediction generation skipped" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Action**: Prediction generation attempted" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- **Timezone**: ${{ env.TZ }}" >> $GITHUB_STEP_SUMMARY
