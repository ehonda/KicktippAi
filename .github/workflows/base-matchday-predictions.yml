name: Base Matchday Predictions

# Reusable workflow for matchday predictions
on:
  workflow_call:
    inputs:
      community_config:
        description: 'Community configuration JSON'
        required: true
        type: string
      trigger_type:
        description: 'How this workflow was triggered (scheduled, manual)'
        required: true
        type: string
      force_prediction:
        description: 'Force prediction even if verify passes'
        required: false
        type: boolean
        default: false
      model_override:
        description: 'Override model from manual trigger'
        required: false
        type: string
    secrets:
      kicktipp_username:
        description: 'Kicktipp username for this community'
        required: true
      kicktipp_password:
        description: 'Kicktipp password for this community'
        required: true
      firebase_project_id:
        description: 'Firebase project ID'
        required: true
      firebase_service_account_json:
        description: 'Firebase service account JSON'
        required: true
      openai_api_key:
        description: 'OpenAI API key'
        required: true

env:
  TZ: 'Europe/Berlin'

jobs:
  matchday-predictions:
    name: Matchday Predictions
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.x'
          
      - name: Restore dependencies
        run: dotnet restore
        
      - name: Build project
        run: dotnet build --no-restore --configuration Release
        
      - name: Parse community configuration
        id: config
        run: |
          # Parse the community configuration JSON
          echo '${{ inputs.community_config }}' > config.json
          
          # Extract configuration values
          COMMUNITY=$(jq -r '.community' config.json)
          MATCH_MODEL=$(jq -r '.predictions.matches.model' config.json)
          COMMUNITY_CONTEXT=$(jq -r '.predictions.matches["community-context"]' config.json)
          
          # Use model override if provided (from manual trigger)
          if [ -n "${{ inputs.model_override }}" ] && [ "${{ inputs.model_override }}" != "" ]; then
            MATCH_MODEL="${{ inputs.model_override }}"
            echo "🎯 Using model override: $MATCH_MODEL"
          fi
          
          echo "📊 Configuration:"
          echo "  Community: $COMMUNITY"
          echo "  Model: $MATCH_MODEL"
          echo "  Community Context: $COMMUNITY_CONTEXT"
          echo "  Trigger: ${{ inputs.trigger_type }}"
          echo "  Force Prediction: ${{ inputs.force_prediction }}"
          
          # Set outputs
          echo "community=$COMMUNITY" >> $GITHUB_OUTPUT
          echo "model=$MATCH_MODEL" >> $GITHUB_OUTPUT
          echo "community_context=$COMMUNITY_CONTEXT" >> $GITHUB_OUTPUT
          
      - name: Verify current predictions
        id: verify
        continue-on-error: true
        run: |
          echo "🔍 Verifying current matchday predictions..."
          echo "Community: ${{ steps.config.outputs.community }}"
          echo "Model: ${{ steps.config.outputs.model }}"
          dotnet run --project src/Orchestrator/Orchestrator.csproj --configuration Release -- verify --community "${{ steps.config.outputs.community }}" --init-matchday --agent
        env:
          KICKTIPP_USERNAME: ${{ secrets.kicktipp_username }}
          KICKTIPP_PASSWORD: ${{ secrets.kicktipp_password }}
          FIREBASE_PROJECT_ID: ${{ secrets.firebase_project_id }}
          FIREBASE_SERVICE_ACCOUNT_JSON: ${{ secrets.firebase_service_account_json }}
          OPENAI_API_KEY: ${{ secrets.openai_api_key }}
          
      - name: Generate and post predictions
        if: steps.verify.outcome == 'failure' || inputs.force_prediction == true
        run: |
          echo "🤖 Generating predictions with model: ${{ steps.config.outputs.model }}"
          echo "Community: ${{ steps.config.outputs.community }}"
          if [ "${{ steps.verify.outcome }}" = "failure" ]; then
            echo "📝 Predictions needed - verify command indicated missing or mismatched predictions"
          else
            echo "🔄 Force prediction enabled - running regardless of verify result"
          fi
          
          dotnet run --project src/Orchestrator/Orchestrator.csproj --configuration Release -- matchday "${{ steps.config.outputs.model }}" --community "${{ steps.config.outputs.community }}" --override-kicktipp --verbose --agent
        env:
          KICKTIPP_USERNAME: ${{ secrets.kicktipp_username }}
          KICKTIPP_PASSWORD: ${{ secrets.kicktipp_password }}
          FIREBASE_PROJECT_ID: ${{ secrets.firebase_project_id }}
          FIREBASE_SERVICE_ACCOUNT_JSON: ${{ secrets.firebase_service_account_json }}
          OPENAI_API_KEY: ${{ secrets.openai_api_key }}
          
      - name: Final verification
        if: steps.verify.outcome == 'failure' || inputs.force_prediction == true
        run: |
          echo "✅ Running final verification to confirm predictions were posted successfully..."
          dotnet run --project src/Orchestrator/Orchestrator.csproj --configuration Release -- verify --community "${{ steps.config.outputs.community }}" --agent
        env:
          KICKTIPP_USERNAME: ${{ secrets.kicktipp_username }}
          KICKTIPP_PASSWORD: ${{ secrets.kicktipp_password }}
          FIREBASE_PROJECT_ID: ${{ secrets.firebase_project_id }}
          FIREBASE_SERVICE_ACCOUNT_JSON: ${{ secrets.firebase_service_account_json }}
          OPENAI_API_KEY: ${{ secrets.openai_api_key }}
          
      - name: Success notification
        if: steps.verify.outcome == 'success' && inputs.force_prediction == false
        run: |
          echo "✅ All predictions are up to date - no action needed"
          
      - name: Workflow summary
        if: always()
        run: |
          echo "## Matchday Predictions Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Community**: ${{ steps.config.outputs.community }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Model**: ${{ steps.config.outputs.model }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Community Context**: ${{ steps.config.outputs.community_context }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: ${{ inputs.trigger_type }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Verify Result**: ${{ steps.verify.outcome }}" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.verify.outcome }}" = "failure" ] || [ "${{ inputs.force_prediction }}" = "true" ]; then
            echo "- **Action**: Predictions generated and posted" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Action**: No predictions needed" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- **Timezone**: ${{ env.TZ }}" >> $GITHUB_STEP_SUMMARY
